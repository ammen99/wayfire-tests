# wayfire-tests

A collection of tests I use for testing Wayfire and discovering regressions.

# Usage

Tests are organized in directories, starting in `./tests`, and each test is contained in its own directory.
To execute a test or group of tests, run:

```sh
./run_tests.sh <test directory> <wayfire A> (--compare-with <wayfire B>)
```

`<test directory>` is the directory which contains all the tests you want to run.
Information about each test run will be printed on the terminal.

`<wayfire A>` is the Wayfire executable/launch script. It should accept the same arguments as the Wayfire executable.

Some of the tests test the graphical output of Wayfire (so called GUI tests in the code).
To make these tests independent of things like GTK themes, etc., these tests require a second Wayfire version to run (the `--compare-with` option).
Both versions are executed with the same configuration and the same IPC commands are fed to them.
At the end, screenshots of both sessions are taken and compared.

### Tips and tricks

The test runner supports running multiple tests in parallel with the `-j <N>` option.
Running many tests in parallel puts a lot of stress on the system (esp. during Wayfire's and client initialization, since these often depend on system calls and the GPU hardware).
To avoid this happening:

- Do not run too many tests in parallel (personal rule of a thumb is to use a bit less than the physical core count, but of course this depends on the system).
- Use the `--interactive` flag. After the tests are run, you will be presented with a list of tests that failed. You can rerun all of them sequentially by typing `run all` at the prompt, most of the tests should now become green. You can also rerun a particular failed test by typing `run <test number>`, or `run <test number> slow` to add extra timeouts.

# How to write a new test

Tests are a combination a python test file and a Wayfire config file.
Currently, the following is required for the python test file:

1. A function `is_gui()` returning whether the test is a GUI test (e.g. compares the graphical output of two Wayfire versions).
2. A class named `WTest` which implements the `WayfireTest` interface defined in `wfpytest/wftest.py`.

The tests can use the modules defined in `wfpytest/` for example to launch Wayfire, communicate with it via IPC, etc.
The test runner automatically switches to each test's directory when executing the given test, so any temporary files can be stored there and
later reviewed (useful for example for the `wayfire.log` file generated by most tests).
